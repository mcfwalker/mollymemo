# Session: 2026-02-27_1157

**Agent:** Claude Opus 4.6

## Focus
Build YouTube ingestion pipeline (MOL-10) for Feature #5 (Extended Content Ingestion Pipelines)

## What Was Done
- Built YouTube processor (`src/lib/processors/youtube.ts`) with URL parsing for all formats (watch, youtu.be, shorts, live, embed)
- Implemented oEmbed metadata fetch (title, author — no API key needed)
- Initially used `youtube-transcript` npm package for captions — discovered it's broken (last updated Apr 2024, returns 0 segments for all videos)
- Also tested `youtube-caption-extractor` and `youtube-transcript-api` — all broken
- Debugged YouTube's internal API: WEB client omits caption tracks, ANDROID client returns them
- Discovered YouTube uses srv3 XML format (`<p>`/`<s>` tags, not legacy `<text>` tags)
- Replaced broken npm package with direct InnerTube ANDROID client API calls
- Wired YouTube case into Inngest `process-item.ts` pipeline
- 18 tests passing (8 URL parsing + 10 processor integration)
- Deployed and verified end-to-end: item captured, classified, tagged, embedded
- **Issue:** InnerTube ANDROID client is flaky on Vercel — captions fetch sometimes fails, falls back to oEmbed metadata-only (86 chars). Works locally but unreliable on server. Needs hardening.
- MOL-10 marked done (pipeline works with metadata fallback)

## Commits
| Hash | Message |
|------|---------|
| 4dcf542 | chore: add youtube-transcript dependency for MOL-10 |
| c7c218a | feat(processors): add YouTube processor with transcript extraction (MOL-10) |
| dadba4f | feat(processors): wire YouTube pipeline into Inngest processing |
| 08383d6 | docs: add YouTube ingestion pipeline plan (MOL-10) |
| 18763db | fix(processors): replace broken youtube-transcript with direct InnerTube API |

## Tech Debt Identified
- [ ] YouTube InnerTube ANDROID client flaky on Vercel — transcript extraction falls back to metadata-only. Need retry logic, multi-client fallback (ANDROID → WEB → page scrape), or alternative approach (HIGH)
- [ ] Pre-existing: Resend API key build failure (local env)
- [ ] Pre-existing: Duplicate "Platform Extensions & Integrations" theme

## CLAUDE.md Updates Needed
None

---

## Next Session

### Suggested Focus
**Fix YouTube transcript extraction reliability.** The InnerTube ANDROID client works locally but is flaky on Vercel (returns no caption tracks). Options to investigate:
1. Add retry logic with multiple InnerTube client types (ANDROID → WEB → MWEB)
2. Fetch watch page HTML server-side and extract ytInitialPlayerResponse (WEB client had tracks in HTML, but caption URL returned empty — may be IP-signature issue)
3. Use a proxy or different approach for caption XML fetch
4. Consider YouTube Data API v3 with API key as reliable fallback

After fixing YouTube, continue clearing Feature #5: MOL-44 (article web clipping) and MOL-45 (LinkedIn pipeline).

### Key Files
- `src/lib/processors/youtube.ts` — YouTube processor (InnerTube ANDROID client, srv3 XML parsing)
- `src/lib/processors/youtube.test.ts` — 18 tests
- `src/inngest/functions/process-item.ts:219-236` — YouTube case in pipeline
- `docs/plans/2026-02-27-youtube-ingestion-pipeline.md` — Original plan

### Kickoff Message
YouTube pipeline (MOL-10) is built and deployed but transcript extraction is unreliable on Vercel. The InnerTube ANDROID client returns captions locally but not consistently on server. The pipeline works end-to-end with metadata-only fallback (title + author from oEmbed). Priority: harden transcript extraction with retry/multi-client strategy, then continue to MOL-44 and MOL-45 to clear Feature #5.
